<%- include('../header') %>

<h2 class="mb-4">Subscriptions</h2>

<% if (subs.length === 0) { %>
  <p class="text-muted">No subscriptions yet.</p>
<% } else { %>
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Customer</th>
          <th>Frequency</th>
          <th>Price</th>
          <th>Next Delivery</th>
          <th>Last Fulfilled</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% subs.forEach(sub => { %>
          <% const overdue = sub.status === 'active' && helpers.isOverdue(sub.next_delivery_date); %>
          <tr class="<%= overdue ? 'table-danger' : sub.status === 'past_due' ? 'table-warning' : '' %>">
            <td>
              <strong><%= sub.product_name || 'Unknown' %></strong>
              <% if (sub.variant) { %>
                <br><small class="text-muted"><%= sub.variant %></small>
              <% } %>
            </td>
            <td>
              <%= sub.customer_email || 'N/A' %>
              <% const addr = helpers.parseAddress(sub.shipping_address); %>
              <% if (addr) { %>
                <div class="mt-1">
                  <small class="text-muted">
                    <i class="bi bi-geo-alt"></i>
                    <%= sub.shipping_name ? sub.shipping_name + ' - ' : '' %><%= addr.line1 || '' %><%= addr.city ? ', ' + addr.city : '' %><%= addr.state ? ', ' + addr.state : '' %> <%= addr.postal_code || '' %>
                  </small>
                </div>
              <% } %>
            </td>
            <td><%= helpers.frequencyLabel(sub.frequency) %></td>
            <td><%= sub.price_cents ? helpers.formatCents(sub.price_cents) : 'N/A' %></td>
            <td>
              <% if (sub.next_delivery_date) { %>
                <span class="<%= overdue ? 'text-danger fw-bold' : '' %>">
                  <%= helpers.formatDate(sub.next_delivery_date) %>
                </span>
                <% if (overdue) { %>
                  <br><small class="text-danger">OVERDUE</small>
                <% } %>
              <% } else { %>
                N/A
              <% } %>
            </td>
            <td><small><%= helpers.formatDateTime(sub.last_fulfilled_at) %></small></td>
            <td>
              <%- helpers.statusBadge(sub.status) %>
              <% if (sub.cancel_at_period_end) { %>
                <br><small class="text-danger">Canceling</small>
              <% } %>
              <% if (sub.status === 'canceled' && sub.cancel_reason) { %>
                <br><small class="text-muted"><%= sub.cancel_reason %></small>
              <% } %>
            </td>
            <td class="text-nowrap">
              <% if (sub.status === 'active') { %>
                <form method="POST" action="<%= base %>/subscriptions/<%= sub.id %>/fulfill" data-confirm="Mark this subscription as fulfilled and send notification email?" class="d-inline">
                  <button class="btn btn-sm btn-outline-success">Fulfill</button>
                </form>
                <form method="POST" action="<%= base %>/subscriptions/<%= sub.id %>/pause" data-confirm="Pause this subscription?" class="d-inline">
                  <button class="btn btn-sm btn-outline-warning">Pause</button>
                </form>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#variantModal-<%= sub.id %>">Change</button>
              <% } else if (sub.status === 'paused') { %>
                <form method="POST" action="<%= base %>/subscriptions/<%= sub.id %>/resume" class="d-inline">
                  <button class="btn btn-sm btn-outline-success">Resume</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
<% } %>

<% subs.forEach(sub => { %>
  <% if (sub.status === 'active') { %>
  <div class="modal fade" id="variantModal-<%= sub.id %>" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="<%= base %>/subscriptions/<%= sub.id %>/variant">
          <div class="modal-header">
            <h5 class="modal-title">Change Variant â€” <%= sub.product_name || 'Subscription' %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Variant</label>
              <%
                let variantOptions = [];
                if (sub.product_variants) {
                  try {
                    const v = JSON.parse(sub.product_variants);
                    if (v.sizes) variantOptions = variantOptions.concat(Array.isArray(v.sizes) ? v.sizes.map(s => typeof s === 'object' ? s.label || s.name : s) : []);
                    if (v.grinds) variantOptions = variantOptions.concat(v.grinds);
                  } catch(e) {}
                }
              %>
              <% if (variantOptions.length > 0) { %>
                <select name="variant" class="form-select">
                  <% variantOptions.forEach(opt => { %>
                    <option value="<%= opt %>" <%= opt === sub.variant ? 'selected' : '' %>><%= opt %></option>
                  <% }); %>
                </select>
              <% } else { %>
                <input type="text" name="variant" class="form-control" value="<%= sub.variant || '' %>" placeholder="e.g. Whole Bean 16oz">
              <% } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Price Override ($)</label>
              <input type="number" name="price_override" class="form-control" step="0.01" min="0"
                     value="<%= sub.price_cents ? (sub.price_cents / 100).toFixed(2) : '' %>"
                     placeholder="Leave empty to keep current">
              <div class="form-text">Stripe will prorate the difference.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <% } %>
<% }); %>

<%- include('../footer') %>
