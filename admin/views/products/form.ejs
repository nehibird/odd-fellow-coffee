<%- include('../header') %>

<div class="mb-3">
  <a href="<%= base %>/products" class="text-decoration-none"><i class="bi bi-arrow-left me-1"></i> Back to Products</a>
</div>

<h2 class="mb-4"><%= product ? 'Edit' : 'New' %> Product</h2>

<div class="card" style="max-width: 600px;">
  <div class="card-body">
    <form method="POST" action="<%= product ? base + '/products/' + product.id : base + '/products' %>" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label" for="name">Name <span class="text-danger">*</span></label>
        <input type="text" name="name" id="name" class="form-control" required
               value="<%= product ? product.name : '' %>" maxlength="100">
      </div>

      <div class="mb-3">
        <label class="form-label" for="category">Category <span class="text-danger">*</span></label>
        <select name="category" id="category" class="form-select" required>
          <option value="coffee" <%= product && product.category === 'coffee' ? 'selected' : '' %>>Coffee</option>
          <option value="bakery" <%= product && product.category === 'bakery' ? 'selected' : '' %>>Bakery</option>
          <option value="hotplate" <%= product && product.category === 'hotplate' ? 'selected' : '' %>>Hot Plate</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label" for="description">Description</label>
        <textarea name="description" id="description" class="form-control" rows="2" maxlength="500"><%= product ? product.description || '' : '' %></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label" for="price">Price ($) <span class="text-danger">*</span></label>
        <input type="number" name="price" id="price" class="form-control" step="0.01" min="0" required
               value="<%= product ? (product.price_cents / 100).toFixed(2) : '' %>">
      </div>

      <div class="mb-3">
        <label class="form-label" for="variants">Variants (JSON)</label>
        <textarea name="variants" id="variants" class="form-control font-monospace" rows="2"
                  placeholder='{"sizes":["8oz","16oz"],"grinds":["whole","medium","fine"]}'><%= product ? product.variants || '' : '' %></textarea>
        <div class="form-text">Optional. JSON object for size/grind options.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Product Image</label>
        <% if (product && product.image) { %>
          <div class="mb-2">
            <img id="currentImage" src="<%= base %>/uploads/products/<%= product.image %>"
                 alt="Current image" style="max-height: 120px; border-radius: 8px; border: 1px solid #dee2e6;">
          </div>
          <div class="form-text mb-2">Current: <code><%= product.image %></code></div>
        <% } %>
        <input type="file" name="imageFile" id="imageFile" class="form-control" accept="image/*">
        <div class="form-text">Upload a new image (max 5MB). Leave empty to keep current image.</div>
        <img id="imagePreview" style="display:none; max-height: 120px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 0.5rem;">
        <!-- Hidden field preserves existing filename when no new file uploaded -->
        <input type="hidden" name="image" value="<%= product ? product.image || '' : '' %>">
      </div>

      <div class="mb-3">
        <label class="form-label" for="stock_quantity">Stock Quantity</label>
        <input type="number" name="stock_quantity" id="stock_quantity" class="form-control" min="0"
               value="<%= product && product.stock_quantity != null ? product.stock_quantity : '' %>"
               placeholder="Leave empty for unlimited">
        <div class="form-text">Leave empty for items with unlimited/untracked stock (e.g. baked-to-order).</div>
      </div>

      <div class="mb-3 form-check">
        <input type="checkbox" name="subscribable" id="subscribable" class="form-check-input" value="1"
               <%= product && product.subscribable ? 'checked' : '' %>>
        <label class="form-check-label" for="subscribable">Available for subscription</label>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-dark"><%= product ? 'Save Changes' : 'Create Product' %></button>
        <a href="<%= base %>/products" class="btn btn-outline-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById('imageFile').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        preview.src = ev.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
    }
  });
</script>

<%- include('../footer') %>
